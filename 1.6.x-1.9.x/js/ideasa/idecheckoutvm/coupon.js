var CheckoutVmCoupon=Class.create();CheckoutVmCoupon.prototype={initialize:function(a,b){this.form=a;this.couponUrl=b.coupon;this.redirectUrl=b.redirect;this.validator=new Validation(this.form);this.popup=null;this.couponCodeId="coupon:code";this.removeCouponeId="remove:coupone";this.couponMessageId="idecheckoutvm-coupon-message";this.buttonCancelCouponId="idecheckoutvm-button-cancel-coupon";this.removeOption=false;this._bind()},_bind:function(){this.popup=new Control.Modal($("idecheckoutvm-link-coupon"),{width:400,overlayOpacity:0.75,className:"modal-idecheckoutvm",fade:true});if(this.popup){this.popup.observe("afterClose",function(a){this.reset()}.bind(this))}},_post:function(){if(this.validator&&this.validator.validate()){var b=Form.serialize(this.form);var a=new Ajax.Request(this.couponUrl,{method:"post",parameters:b,onSuccess:this._onSuccess.bindAsEventListener(this)})}return false},_onSuccess:function(transport){var response=null;if(transport&&transport.responseText){try{response=eval("("+transport.responseText+")")}catch(e){response={}}}if(response.success){if(response.message){this._showNoteMessage(response.message)}if(response.updateSection.couponDiscount!=null){if(response.updateSection.couponDiscount.html!=null&&response.updateSection.couponDiscount.html!=""){$(this.buttonCancelCouponId).show()}else{$(this.buttonCancelCouponId).hide()}}else{$(this.buttonCancelCouponId).hide()}checkout.updateBlock(response.updateSection.shippingMethod);checkout.updateBlock(response.updateSection.paymentMethod);checkout.updateBlock(response.updateSection.review)}else{if(response.error){if(response.errorMessage.message){this._showErrorMessage(response.errorMessage.message)}else{this._clearMessage()}if(response.errorMessage.errorFields){var ideCheckoutValidationInst=new IdeCheckoutvmValidation(this.form);ideCheckoutValidationInst.fillFormErrors(response.errorMessage.errorFields)}}}},_showErrorMessage:function(b){var a='<div id="messages"><ul class="messages"><li class="error-msg"><ul><li><span>'+b+"</span></li></ul></li></ul></div>";$(this.couponMessageId).update(a)},_showNoteMessage:function(b){var a='<div id="messages"><ul class="messages"><li class="note-msg"><ul><li><span>'+b+"</span></li></ul></li></ul></div>";$(this.couponMessageId).update(a)},_clearMessage:function(){$(this.couponMessageId).update("")},reset:function(){$(this.couponCodeId).setValue("");this._clearMessage();this.validator.reset()},doValid:function(){this.removeOption=false;$(this.couponCodeId).addClassName("required-entry");$(this.removeCouponeId).setValue("0");this._post()},doCancel:function(){this.removeOption=true;$(this.couponCodeId).removeClassName("required-entry");$(this.removeCouponeId).setValue("1");this._post()},doClose:function(){this.popup.close()}};